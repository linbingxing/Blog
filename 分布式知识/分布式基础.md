# 分布式基础

## 分布式系统的 CAP 理论

### CAP 代表什么含义

CAP 理论可以表述为，一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition Tolerance）这三项中的两项。

CAP 定理表明，在存在网络分区的情况下，一致性和可用性必须二选一。一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。当网络发生分区（不同节点之间的网络发生故障或者延迟较大）时，要么失去一致性（允许不同分区的数据写入），要么失去可用性（识别到网络分区时停止服务）。一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。在出现网络分区的时候

- 如果系统不允许写入，那么意味着降低了系统的可用性，但不同分区的数据能够保持一致，即选择了一致性。
- 如果系统允许写入，那么意味着不同分区之间的数据产生不一致，系统可用性得到保障，即选择可用性。

![CAP](D:\Blog\分布式知识\CAP.png)

#### Consistency(一致性)

一致性是指所有节点在同一时间的数据完全一致，即更新操作成功并返回客户端完成后，所有节点在同一时间的数据完全一致，等同于所有节点拥有数据的最新版本。

在分布式系统当中，针对不同情况以及不同要求下的一致性，设计了多种不同的模型。我们可以简单做一个总结，将它们分为三类：

- 强一致性，要求当下更新成功的数据立即生效，在后续的访问当中都能返回最新的结果。
- 弱一致性，如果能容忍在更新发生之后，部分情况无法访问到最新数据。
- 最终一致性，如果能容忍更新后一段时间内无法访问到最新数据，但最终可以保证结果准确。

在CAP理论当中，我们说的无法同时满足的一致性指的是**强一致性**。

对于一致性，可以分为从客户端和服务端两个不同的视角。

- 客户端

从客户端来看，一致性主要指的是多并发访问时更新过的数据如何获取的问题。

- 服务端

从服务端来看，则是更新如何分布到整个系统，以保证数据最终一致。

#### Availability(可用性)

可用性是指“任何时候，读写都是成功的”，即服务一直可用，而且是正常响应时间。

一个高可用性的分布式系统，必须对用户的每一个请求做出响应。不可以出现无法访问或者是响应超时等影响用户体验的情况。在一个分布式系统当中，任何一个节点的不稳定，都有可能影响系统的可用性，比如数据库服务器、负载均衡，web服务器承载等等。为了量化系统的可用性，我们通常使用系统停机时间这个指标。即在一年时间内，系统停机的总时长。我们平时会看到一些 IT 公司的对外宣传，比如系统稳定性已经做到 3 个 9、4 个 9，即 99.9%、99.99%，这里的 N 个 9 就是对可用性的一个描述，叫做 SLA，即服务水平协议。比如我们说月度 99.95% 的 SLA，则意味着每个月服务出现故障的时间只能占总时间的 0.05%，如果这个月是 30 天，那么就是 21.6 分钟。

| 可用性分类                   | 可用水平（%） | 年可容忍停机视角 |
| ---------------------------- | ------------- | ---------------- |
| 容错可用性                   | 99.9999       | < 1min           |
| 极高可用性                   | 99.999        | < 5min           |
| 具有故障自动恢复能力的高可用 | 99.99         | < 53min          |
| 高可用                       | 99.9          | < 8.8h           |
|                              |               |                  |

#### Partition tolerance(分区容错性)

分区容错性是指“当部分节点出现消息丢失或者分区故障的时候，分布式系统仍然能够继续运行”，即系统容忍网络出现分区，并且在遇到某节点或网络分区之间网络不可达的情况下，仍然能够对外提供满足一致性和可用性的服务。

### CAP 理论的应用
CAP 理论提醒我们，在架构设计中，不要把精力浪费在如何设计能满足三者的完美分布式系统上，而要合理进行取舍，CAP 理论类似数学上的不可能三角，只能三者选其二，不能全部获得。


不同业务对于一致性的要求是不同的。举个例来讲，在微博上发表评论和点赞，用户对不一致是不敏感的，可以容忍相对较长时间的不一致，只要做好本地的交互，并不会影响用户体验；而我们在电商购物时，产品价格数据则是要求强一致性的，如果商家更改价格不能实时生效，则会对交易成功率有非常大的影响。


需要注意的是，CAP 理论中是忽略网络延迟的，也就是当事务提交时，节点间的数据复制一定是需要花费时间的。即使是同一个机房，从节点 A 复制到节点 B，由于现实中网络不是实时的，所以总会有一定的时间不一致。

### CP 和 AP 架构的取舍
在通常的分布式系统中，为了保证数据的高可用，通常会将数据保留多个副本（Replica），网络分区是既成的现实，于是只能在可用性和一致性两者间做出选择。CAP 理论关注的是在绝对情况下，在工程上，可用性和一致性并不是完全对立的，我们关注的往往是如何在保持相对一致性的前提下，提高系统的可用性。


业务上对一致性的要求会直接反映在系统设计中，典型的就是 CP 和 AP 结构。


CP 架构：对于 CP 来说，放弃可用性，追求一致性和分区容错性。

我们熟悉的 ZooKeeper，就是采用了 CP 一致性，ZooKeeper 是一个分布式的服务框架，主要用来解决分布式集群中应用系统的协调和一致性问题。其核心算法是 Zab，所有设计都是为了一致性。在 CAP 模型中，ZooKeeper 是 CP，这意味着面对网络分区时，为了保持一致性，它是不可用的。关于 Zab 协议，将会在后面的 ZooKeeper 课时中介绍。


AP 架构：对于 AP 来说，放弃强一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择，后面的 Base 也是根据 AP 来扩展的。

和 ZooKeeper 相对的是 Eureka，Eureka 是 Spring Cloud 微服务技术栈中的服务发现组件，Eureka 的各个节点都是平等的，几个节点挂掉不影响正常节点的工作，剩余的节点依然可以提供注册和查询服务，只要有一台 Eureka 还在，就能保证注册服务可用，只不过查到的信息可能不是最新的版本，不保证一致性。

## Base 理论

Base 是三个短语的简写，即基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）。

Base 理论的核心思想是**最终一致性，即使无法做到强一致性（Strong Consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual Consistency）**。

接下来看一下BASE中的三要素：

#### 基本可用

基本可用是指分布式系统在出现不可预知故障的情况下，允许损失部分可用性。不代表系统不可用。

（1）响应时间上的损失。正常情况下，一个商品搜索返回给用户相应的查询结果，但由于出现故障，查询结果的响应时间增加了几秒响应。

（2）系统功能上的损失。正常情况下，在双十一秒杀活动中，如果抢购人数太多超过了系统的 QPS 峰值，可能会排队或者提示限流，这就是通过合理的手段保护系统的稳定性，保证主要的服务正常，保证基本可用。

#### 软状态

软状态是指允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。

#### 最终一致性

最终一致性强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。在系统设计中，最终一致性实现的时间取决于网络延时、系统负载、不同的存储选型、不同数据复制方案设计等因素。

总的来说，Base 理论是在 CAP 上发展的，CAP 理论描述了分布式系统中数据一致性、可用性、分区容错性之间的制约关系，当你选择了其中的两个时，就不得不对剩下的一个做一定程度的牺牲。

Base 理论则是对 CAP 理论的实际应用，也就是在分区和副本存在的前提下，通过一定的系统设计方案，放弃强一致性，实现基本可用，这是大部分分布式系统的选择，比如 NoSQL 系统、微服务架构。Base 理论面向的是高可用、可扩展的分布式系统。

### 



